#! /bin/sh

BASEDIR=$(dirname $(readlink -f $0))/$1
FIXDIR=$BASEDIR/mapped
PRCDIR=$BASEDIR/.processing
TARDIR=$BASEDIR/publish

TS=`date +%s%N`
TMPPIC=/tmp/tmpToParse_$TS
TMPACC=/tmp/tmpAccts_$TS

umask 000

#seperate group dist
while ls $PRCDIR/*.jpg 2> /dev/null | grep '\(.*,.*\).jpg' > $TMPPIC
do
  cat $TMPPIC | sed 's:.*/::' > $TMPPIC
  sed 's:(\(.*\),\(.*\))\(.*\):cp "'$PRCDIR'/&" "'$PRCDIR'/(\2)\3"; mv "'$PRCDIR'/&" "'$PRCDIR'/(\1)\3":' < $TMPPIC |
      sh
done

# parse (All)
ls $BASEDIR/watermark/*.png | grep '[^-]*-0-.*\.png$' | sed 's:.*/\([^-]*\)-0-.*\.png$:\1:' > $TMPACC

for img in $(ls $PRCDIR/*.jpg 2> /dev/null | grep '(\(_all\|_all-.*\)).*\.jpg$')
do
  for acct in $(cat $TMPACC)
  do
   	echo $img | sed "s:\(.*\)/(_all\(-.*\)\?)\(.*\)$:cp \"&\" \"\1/($acct\2)\3\":" |
      sh
  done
done
exit 0
# assign default wm
for img in $(ls $PRCDIR/*.jpg 2> /dev/null | grep -v '(.*-.*).*\.jpg')
do
  echo $img | sed 's:\(.*\)/(\(.*\))\(.*\)$:mv "&" "\1/(\2-1)\3":' |
    sh
done

# manipulate
for img in $(ls $PRCDIR/*.jpg 2> /dev/null)
do
  target=$(echo $img | sed 's:.*/(.*)\(.*\)$:\1:')
  tag=$(echo $img | sed 's:.*/(\(.*\)).*\.jpg$:\1:')
  wm=$(ls $BASEDIR/watermark/$tag*.png 2> /dev/null)

  if [ $? -eq 0 ];	then
  	wm=$(echo $wm | head -n 1)
  	tok='\([^-]*\)-\?'
  	pat=$tok$tok$tok$tok

  	acc=$(echo $wm | sed 's:.*/'$pat'.png$:\1:')

  	mrg=$(echo $wm | sed 's:.*/'$pat'.png$:\3:')
  	mrg=$(echo ${mrg:-over})
  	
  	dim=$(echo $wm | sed 's:.*/'$pat'.png$:\4:')
  	dim=$(echo ${dim:-800x600})

  	ls -d $TARDIR/$acc 1> /dev/null 2>&1
  
  	if [ $? != 0 ]; then
	    mkdir -m 777 $TARDIR/$acc
  	fi

  	convert $img -resize $dim^ -gravity center -extent $dim -compose $mrg $wm -composite $img
   	mv $img $TARDIR/$acc/$target
  	echo $TARDIR/$acc/$target
  
  else
    echo $img | grep '.*/(.*-_del_)'
    if [ $? -eq 0 ]; then
      acc=$(echo $img | sed 's:.*/(\(.*\)-_del_).*:\1:')
    	ls -d $TARDIR/$acc 1> /dev/null 2>&1
  
    	if [ $? != 0 ]; then
  	    mkdir -m 777 $TARDIR/$acc
    	fi

      cp $BASEDIR/blank.jpg $TARDIR/$acc/$target
      rm $img
    fi
  fi
done
