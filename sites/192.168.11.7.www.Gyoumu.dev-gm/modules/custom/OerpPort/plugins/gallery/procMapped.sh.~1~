#! /bin/sh

BASEDIR=$(dirname $(readlink -f $0))/$1
FIXDIR=$BASEDIR/mapped
PRCDIR=$BASEDIR/.processing
MANDIR=$BASEDIR/.manipulating

TS=`date +%s%N`
TMPPIC=/tmp/tmpToParse_$TS
TMPACC=/tmp/tmpAccts_$TS

#seperate group dist
while ls $PRCDIR/*.jpg 2> /dev/null | grep '\(.*,.*\).jpg$' > $TMPPIC
do
  cat $TMPPIC | sed 's:.*/::' > $TMPPIC
  sed 's:(\(.*\),\(.*\))\(.*\):cp "'$PRCDIR'/&" "'$PRCDIR'/(\2)\3"; mv "'$PRCDIR'/&" "'$PRCDIR'/(\1)\3":' < $TMPPIC |
      sh
done

# parse (All)
ls $BASEDIR/watermark/*.png | grep '[^-]*-0-.*\.png$' | sed 's:.*/\([^-]*\)-0-.*\.png$:\1:' > $TMPACC

for img in $(ls $PRCDIR/*.jpg 2> /dev/null | grep '(\(All\|All-.*\)).*\.jpg$')
do
  for acct in $(cat $TMPACC)
  do
    echo $acct | grep -v 'All' 1> /dev/null 2>&1

    if [ $? -eq 0 ]; then
    	echo $img | sed 's:\(.*\)/(All\(-.*\)\?)\(.*\)$:cp "&" "\1/('$acct'\2)\3":' |
        sh
    fi
  done
done

# assign default wm
for img in $(ls $PRCDIR/*.jpg 2> /dev/null | grep -v '(\(All\|All-.*\|.*-.*\)).*\.jpg$')
do
  echo $img | sed 's:\(.*\)/(\(.*\))\(.*\)$:mv "&" "\1/(\2-1)\3":' |
    sh
done

