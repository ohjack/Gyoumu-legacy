<?php
use Ebapi as E;
require_once 'ebapi_fitment.inc';

function ebapi_fitment_menu()
{
  $items = array();

  $items['ebapi/fitment/reload'] = array(
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ebapi_fitment_reload_form'),
    'access callback' => true,
    'type' => MENU_CALLBACK,
  );

  $items['ebapi/fitment/select/js'] = array(
    'page callback' => 'ebapi_fitment_select_js',
    'access callback' => true,
    'type' => MENU_CALLBACK,
  );

  $items['ebapi/fitment/select'] = array(
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ebapi_fitment_select_form'),
    'access callback' => true,
    'type' => MENU_CALLBACK,
  );

  $items['ebapi/fitment/edit'] = array(
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ebapi_fitment_edit_form'),
    'access callback' => true,
    'type' => MENU_CALLBACK,
  );

  return $items;
}

function ebapi_fitment_theme(){
  return array(
    'ebapi_fitment_selector' => array(
      'arguments' => array(),
    ),
  );
}

function ebapi_fitment_elements(){
  return array(
    'ebapi_fitment_selector' => array(
      '#input' => true,
      '#value' => null,
      '#process' => array('ebapi_fitment_selector_process'),
    ),
  );
}

function ebapi_fitment_selector_process($ele, $edit, &$form_state, $form)
{
  $ctrl = new E\CompatibilityListController($form_state);
  $ele = array_merge($ele, $ctrl->getFormEntry($form_state));
  $ele['#prefix'] = '<div id="ebapi-compatibility-wrapper">';
  $ele['#suffix'] = '</div>';
  return $ele;
}

function theme_ebapi_fitment_selector($ele)
{
  return $ele['#children'];
}

function ebapi_fitment_reload_form(&$form_state)
{
  $l = new E\CsvSerialLoader();
  return $l->getSourceEntry();
}

function ebapi_fitment_reload_form_submit($form, &$form_state)
{
  $l = new E\CsvSerialLoader();
  $l->reload($form_state['values']['source']);
}

function ebapi_fitment_edit_form(&$form_state)
{
  $form = array();
  $form['fitment'] = array(
    '#type' => 'ebapi_fitment_selector'
  );

//  $form['list'] = array(
//    '#type' => 'fieldset',
//    '#prefix' => '<div class="listing-selector">',
//    '#suffix' => '</div>',
//  );

  $t = new E\PageMySelling($form_state);
  $form['listings'] = $t->hook_form($form_state);
  
  drupal_add_css(drupal_get_path('module', 'ebapi') . '/ebapi.css');
  return $form;
}

function ebapi_fitment_edit_form_submit($form, &$form_state)
{
  $vals = $form_state['values'];
  $selFitment = (array)json_decode($vals['selected']);
  $comp_send = array();

  foreach(array_keys($selFitment) as $ePID){
    $fit = new E\Fitment($ePID);
    $flds = array('Make', 'Model', 'Submodel', 'Body', 'NumDoors', 'Trim', 'Year', 'Engine');

    if($data = $fit->getData()){
      $rec = array();
      foreach($flds as $fld){
        $rec['NameValueList'][] = array(
          'Name' => $fld,
          'Value' => $data->$fld,
        );
      }
      $comp_send['Compatibility'][] = $rec;
    }
  }

  $comp_send['ReplaceAll'] = 'true';
  $l_count = 0;

  foreach($vals as $name => $val)
  {
    if(preg_match('/^sel-(.*)/', $name, $m) && $val){
      $item = Services_Ebay::loadModel('Item', $m[1], E\ApiController::getSession());
      $item->Get();

      $item->ItemCompatibilityList = $comp_send;
      $item->Revise();
      $l_count++;
    }
  }
  drupal_set_message('Updated Fitments of ' . $l_count . ' listing(s).');
}

function ebapi_fitment_select_form(&$form_state)
{
  $ctrl = new E\CompatibilityListController($form_state);
  return $ctrl->getFormEntry();
}

function ebapi_fitment_select_js()
{
  $form_id = 'ebapi_fitment_select_form';
  $form_state['values'] = $_POST;
  $form = ebapi_fitment_select_form($form_state);

  drupal_process_form($form_id, $form, $form_state);
  $output = theme('status_messages') . drupal_render($form);

  drupal_json(array('status' => TRUE, 'data' => $output));
}